å•Šï¼Œå®Œå…¨ç†è§£è¿™ä¸ªâ€œå°´å°¬â€ï¼ ğŸ˜„ è¿™ç¡®å®æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„ä¿¡æ¯ï¼Œå®ƒå½»åº•æ”¹å˜äº†æˆ‘ä»¬ä¹‹å‰å…³äº Django é¡µé¢æ¸²æŸ“å’Œè·³è½¬çš„è®¨è®ºæ–¹å‘ã€‚

æ—¢ç„¶å·¥ä½œæµå¼•æ“çš„å‰ç«¯æ˜¯ **React å•é¡µåº”ç”¨ (SPA)**ï¼Œé‚£ä¹ˆï¼š

*   **ä¸å†æœ‰ Django æ¨¡æ¿æ¸²æŸ“**: å¯¹äºå·¥ä½œæµå¼•æ“éƒ¨åˆ†ï¼ŒDjango ä¸ä¼šè´Ÿè´£æ¸²æŸ“ `workflows/task_list.html` è¿™æ ·çš„æ¨¡æ¿ã€‚æ•´ä¸ªå‰ç«¯ç•Œé¢æ˜¯ç”±æµè§ˆå™¨ä¸­çš„ JavaScript (React) æ„å»ºçš„ã€‚
*   **å®¢æˆ·ç«¯è·¯ç”±**: React åº”ç”¨å†…éƒ¨ä¼šä½¿ç”¨ä¸€ä¸ªè·¯ç”±åº“ï¼ˆå¾ˆå¯èƒ½æ˜¯ `react-router-dom`ï¼‰æ¥å¤„ç†é¡µé¢é—´çš„å¯¼èˆªï¼ˆä¾‹å¦‚ä»ä»»åŠ¡åˆ—è¡¨åˆ‡æ¢åˆ°è®¾è®¡å™¨ï¼‰ã€‚æµè§ˆå™¨åœ°å€æ çš„ URL å˜åŒ–ï¼ˆæ¯”å¦‚å˜æˆ `/workflows/tasks` æˆ– `/workflows/designer/123`ï¼‰æ˜¯ç”± React Router æ•è·å¹¶ç”¨äºæ¸²æŸ“ä¸åŒçš„ React ç»„ä»¶ï¼Œè€Œä¸æ˜¯å‘ Django åç«¯è¯·æ±‚ä¸€ä¸ªæ–°çš„ HTML é¡µé¢ã€‚
*   **Django çš„è§’è‰²**: å¯¹äº React SPA æ¥è¯´ï¼ŒDjango çš„ä¸»è¦è§’è‰²å˜æˆäº†ï¼š
    1.  **æä¾› API**: é€šè¿‡æˆ‘ä»¬ä¹‹å‰é…ç½®çš„ `/api/workflows/...` ç«¯ç‚¹æä¾›æ•°æ®å’Œæ‰§è¡Œæ“ä½œã€‚React ç»„ä»¶ä¼šé€šè¿‡ `fetch` æˆ– `axios` è°ƒç”¨è¿™äº› APIã€‚
    2.  **æä¾›å…¥å£**: éœ€è¦æœ‰ä¸€ä¸ª Django URL æ¥æä¾› React åº”ç”¨çš„â€œå¤–å£³â€â€”â€”å³ `frontend/build/index.html` æ–‡ä»¶ï¼ˆæˆ–å…¶ä»–æ„å»ºè¾“å‡ºçš„ä¸» HTML æ–‡ä»¶ï¼‰ã€‚ç”¨æˆ·é¦–æ¬¡è®¿é—® React åº”ç”¨æ—¶ï¼ŒDjango éœ€è¦å‘é€è¿™ä¸ª HTML æ–‡ä»¶ç»™æµè§ˆå™¨ã€‚
    3.  **è®¤è¯ä¸æˆæƒ**: é€šè¿‡ API ç«¯ç‚¹çš„æƒé™æ£€æŸ¥ï¼ˆæ¯”å¦‚æˆ‘ä»¬é…ç½®çš„ `CanUseWorkflows`ï¼‰æ¥ä¿æŠ¤åç«¯èµ„æºã€‚

**ç°åœ¨æˆ‘ä»¬é‡æ–°æ¥çœ‹ä½ çš„é—®é¢˜ï¼šå¦‚ä½•ä» `myapp` (Django æ¸²æŸ“) è·³è½¬åˆ° `workflows` (React SPA) å¹¶ä¿æŒ Sessionï¼Ÿ**

**å¥½æ¶ˆæ¯ï¼šSession ä¿æŒæ˜¯è‡ªåŠ¨çš„ï¼**

åªè¦ `myapp` å’ŒåŠ è½½ React SPA çš„ URL å±äºåŒä¸€ä¸ª Django é¡¹ç›®ï¼ˆåœ¨åŒä¸€ä¸ªåŸŸåä¸‹ï¼‰ï¼Œå¹¶ä¸”ä½ çš„ Session é…ç½®æ­£ç¡®ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å‘é€ `sessionid` Cookieï¼ŒDjango åç«¯çš„ `SessionMiddleware` ä¼šè‡ªåŠ¨ä¸ºä½ åŠ è½½ `request.session`ã€‚è¿™å¯¹äºåŠ è½½ React SPA çš„å…¥å£ HTML è¯·æ±‚å’Œ React SPA å‘å‡ºçš„æ‰€æœ‰ API è¯·æ±‚éƒ½æœ‰æ•ˆã€‚

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•é…ç½® URL ä»¥åŠ è½½ React SPAï¼Ÿ**

ä½ éœ€è¦ä¸€ä¸ª Django URL å’Œè§†å›¾æ¥æä¾› React åº”ç”¨çš„å…¥å£ç‚¹ (`index.html`)ã€‚

**æ–¹æ¡ˆï¼šè®© Django åœ¨ç‰¹å®šè·¯å¾„ä¸‹æä¾› React åº”ç”¨**

å‡è®¾ä½ å¸Œæœ›ç”¨æˆ·é€šè¿‡è®¿é—® `/workflows/` è¿™ä¸ªåŸºç¡€è·¯å¾„æ¥åŠ è½½å’Œä½¿ç”¨ React å·¥ä½œæµåº”ç”¨ã€‚

1.  **é…ç½® Django è§†å›¾æ¥æä¾› `index.html`**:
    *   ä½ éœ€è¦ä¸€ä¸ªè§†å›¾ï¼Œå®ƒçš„ä½œç”¨ä»…ä»…æ˜¯è¿”å›ç”± Vite æ„å»ºäº§ç”Ÿçš„ `index.html` æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶é€šå¸¸ä½äº `frontend/dist/index.html`ï¼ˆæˆ–è€…ä½  `vite.config.js` ä¸­ `build.outDir` æŒ‡å®šçš„å…¶ä»–ä½ç½®ï¼‰ã€‚
    *   **é‡è¦**: è®¿é—®è¿™ä¸ª React åº”ç”¨çš„å…¥å£æœ¬èº«ä¹Ÿéœ€è¦ç™»å½•ä¿æŠ¤ã€‚

    ```python
    # workflows/views.py
    from django.shortcuts import render
    from django.conf import settings
    import os
    # from .permissions import custom_login_required # ä½¿ç”¨ä½ çš„è‡ªå®šä¹‰è£…é¥°å™¨

    @custom_login_required # ä¿æŠ¤è¿™ä¸ªå…¥å£è§†å›¾
    def workflow_spa_entry(request, *args, **kwargs):
        """
        æä¾› React SPA çš„å…¥å£ index.htmlã€‚
        """
        # æ³¨æ„ï¼šè¿™é‡Œçš„è·¯å¾„éœ€è¦æ ¹æ®ä½ çš„é¡¹ç›®ç»“æ„å’Œ Vite æ„å»ºè¾“å‡ºä½ç½®è°ƒæ•´
        # é€šå¸¸ Vite æ„å»ºè¾“å‡ºåœ¨ frontend/dist/ æˆ– settings.py ä¸­é…ç½®çš„ STATIC_ROOT ä¸‹çš„æŸä¸ªå­ç›®å½•
        # index_html_path = os.path.join(settings.STATIC_ROOT, 'frontend', 'index.html')
        # æˆ–è€…ï¼Œå¦‚æœ 'frontend/dist' ç›´æ¥åœ¨ä½ çš„ TEMPLATES DIRS ä¸‹ï¼š
        # return render(request, 'frontend/dist/index.html')

        # å‡è®¾ Vite çš„ build.outDir æ˜¯ '../staticfiles/frontend' (ç›¸å¯¹äº vite.config.js)
        # å¹¶ä¸”ä½ çš„ Django settings.py ä¸­çš„ STATICFILES_DIRS åŒ…å«äº†è¿™ä¸ª 'staticfiles' ç›®å½•
        # æˆ–è€…è¿™ä¸ªæ„å»ºè¾“å‡ºç›®å½•è¢«åŒ…å«åœ¨äº† TEMPLATES çš„ DIRS è®¾ç½®ä¸­
        # æœ€ç®€å•çš„æ–¹å¼å¯èƒ½æ˜¯ç›´æ¥æ¸²æŸ“è¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœå®ƒåœ¨æ¨¡æ¿ç›®å½•ä¸­
        # ç¡®ä¿ Django çš„ TEMPLATES è®¾ç½®èƒ½æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶
        # ä¾‹å¦‚ TEMPLATES = [{'DIRS': [BASE_DIR / 'staticfiles'], ...}]
        try:
             # å°è¯•æ¸²æŸ“ä½äº 'staticfiles/frontend/index.html' çš„æ–‡ä»¶
             # ç¡®ä¿ Django çš„æ¨¡æ¿åŠ è½½å™¨èƒ½æ‰¾åˆ°è¿™ä¸ªè·¯å¾„
             # æˆ–è€…ä½ å¯èƒ½éœ€è¦æ›´å¤æ‚çš„é€»è¾‘æ¥ç¡®å®šæ­£ç¡®çš„é™æ€æ–‡ä»¶è·¯å¾„
             return render(request, 'frontend/index.html')
        except Exception as e:
             # å¤„ç†æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–å…¶ä»–é”™è¯¯
             from django.http import HttpResponseNotFound
             print(f"Error rendering SPA entry: {e}") # è°ƒè¯•ä¿¡æ¯
             return HttpResponseNotFound("Workflow application not found.")

    # ... ä½ å…¶ä»–çš„ API è§†å›¾ ...
    ```
    *   **è·¯å¾„é—®é¢˜**: æ­£ç¡®æ‰¾åˆ°å¹¶æä¾› `index.html` çš„è·¯å¾„æ˜¯è¿™é‡Œçš„å…³é”®ã€‚ä½ éœ€è¦ç¡®ä¿ Django çš„æ¨¡æ¿è®¾ç½® (`TEMPLATES['DIRS']`) æˆ–é™æ€æ–‡ä»¶è®¾ç½® (`STATICFILES_DIRS`) èƒ½å¤Ÿè®© Django æ‰¾åˆ° Vite æ„å»ºå‡ºçš„ `index.html`ã€‚`vite.config.js` ä¸­çš„ `build.outDir: '../staticfiles/frontend'` æ„å‘³ç€æ„å»ºç»“æœåœ¨ `frontend` ç›®å½•çš„**ä¸Šä¸€çº§**çš„ `staticfiles/frontend` ç›®å½•ä¸­ã€‚ä½ éœ€è¦è®© Django çŸ¥é“è¿™ä¸ª `staticfiles` ç›®å½•ã€‚

2.  **é…ç½® URL è·¯ç”±**:
    *   æˆ‘ä»¬éœ€è¦ä¸€ä¸ª URL æ¨¡å¼æŒ‡å‘è¿™ä¸ª `workflow_spa_entry` è§†å›¾ã€‚
    *   ä¸ºäº†è®© React Router èƒ½å¤Ÿå¤„ç† `/workflows/tasks`, `/workflows/designer/123` ç­‰è·¯å¾„ï¼ˆåŒ…æ‹¬æµè§ˆå™¨åˆ·æ–°æ—¶ï¼‰ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦ä¸€ä¸ªâ€œé€šé…ç¬¦â€è·¯ç”±ï¼Œå°† `/workflows/` ä¸‹çš„æ‰€æœ‰æœªè¢« API è·¯ç”±åŒ¹é…çš„è·¯å¾„éƒ½æŒ‡å‘è¿™ä¸ªå…¥å£è§†å›¾ã€‚

    ```python
    # workflows/urls.py (æˆ–è€…ä¸» urls.py)
    from django.urls import path, re_path, include # å¯¼å…¥ re_path
    from . import views

    # ... (ä½ çš„ API router å’Œ api_urlpatterns å®šä¹‰ä¿æŒä¸å˜) ...
    api_urlpatterns = [
        path('', include(router.urls)),
        path('designer/config/', views.WorkflowDesignerConfigView.as_view(), name='workflow-designer-config'),
    ]

    # é¡µé¢/SPA å…¥å£ URL
    page_urlpatterns = [
        # ï¼ï¼ï¼ä¸º React SPA å®šä¹‰å…¥å£è§†å›¾ï¼ï¼ï¼
        # åŒ¹é… /workflows/ (åŸºç¡€è·¯å¾„)
        path('', views.workflow_spa_entry, name='workflow_spa_index'),

        # ï¼ï¼ï¼é€šé…ç¬¦è·¯ç”±ï¼Œæ•è·æ‰€æœ‰ workflows/ ä¸‹çš„è·¯å¾„ï¼Œäº¤ç»™å‰ç«¯è·¯ç”±å¤„ç†ï¼ï¼ï¼
        # ç¡®ä¿è¿™ä¸ªæ”¾åœ¨å…¶ä»–å…·ä½“è·¯å¾„ä¹‹åï¼Œæˆ–è€…ç¡®ä¿å®ƒä¸ä¼šæ„å¤–æ•è· API è·¯å¾„
        # ä½¿ç”¨ re_path æ¥åŒ¹é…ä»»ä½•å­—ç¬¦ (.)*
        re_path(r'^(?:.*)/$', views.workflow_spa_entry, name='workflow_spa_catchall'),
        # å¯èƒ½è¿˜éœ€è¦ä¸€ä¸ªä¸å¸¦æœ«å°¾æ–œæ çš„ç‰ˆæœ¬ï¼Œå–å†³äºä½ çš„æœåŠ¡å™¨é…ç½®
        re_path(r'^(?:.*)$', views.workflow_spa_entry, name='workflow_spa_catchall_no_slash'),

        # æ³¨æ„ï¼šå¦‚æœä½ æœ‰å…¶ä»–æ˜ç¡®çš„ Django æ¸²æŸ“çš„é¡µé¢ï¼Œéœ€è¦æ”¾åœ¨é€šé…ç¬¦ä¹‹å‰
        # path('some-django-page/', views.some_view, name='some_page'),
    ]

    # ä¸»é¡¹ç›® urls.py ä¸­åˆ†åˆ« include
    # path('api/workflows/', include((api_urlpatterns, 'workflows-api'), namespace='workflows-api')),
    # path('workflows/', include((page_urlpatterns, 'workflows-pages'), namespace='workflows-pages')),
    ```
    *   `path('', ... name='workflow_spa_index')` å¤„ç† `/workflows/` è¿™ä¸ªåŸºç¡€è·¯å¾„ã€‚
    *   `re_path(r'^(?:.*)/$', ...)` å’Œ `re_path(r'^(?:.*)$', ...)` æ˜¯å…³é”®ï¼Œå®ƒä»¬åŒ¹é… `/workflows/` ä¸‹é¢çš„**ä»»ä½•è·¯å¾„**ï¼ˆä¾‹å¦‚ `/workflows/tasks`, `/workflows/designer/123` ç­‰ï¼‰ï¼Œå¹¶å°†è¯·æ±‚**å…¨éƒ¨äº¤ç»™** `workflow_spa_entry` è§†å›¾ã€‚è¿™ä¸ªè§†å›¾åªè¿”å› `index.html`ï¼Œç„¶åæµè§ˆå™¨ä¸­çš„ React Router ä¼šè¯»å– URL (`/workflows/tasks`) å¹¶æ¸²æŸ“æ­£ç¡®çš„ç»„ä»¶ã€‚

3.  **ä¿®æ”¹ `myapp` æ¨¡æ¿ä¸­çš„é“¾æ¥**:
    é“¾æ¥çš„ç›®æ ‡åº”è¯¥æ˜¯åŠ è½½ React SPA çš„åŸºç¡€è·¯å¾„ã€‚

    ```html
    {# myapp/templates/myapp/some_template.html #}
    {# æŒ‡å‘åŠ è½½ React SPA çš„åŸºç¡€ URL #}
    <a href="{% url 'workflows-pages:workflow_spa_index' %}" class="nav-item">
        <i class="fas fa-tasks"></i>
        <span>ä»»åŠ¡</span> {# æˆ–è€…æ”¹ä¸º "å·¥ä½œæµ" #}
    </a>
    ```
    *   ç°åœ¨ `{% url %}` æŒ‡å‘çš„æ˜¯åä¸º `workflow_spa_index` çš„ URLï¼Œå®ƒä¼šæ¸²æŸ“ React åº”ç”¨çš„å…¥å£ã€‚

**æ€»ç»“ä¸åç»­æ­¥éª¤:**

1.  **ç¡®è®¤ React SPA å…¥å£**: ç¡®å®šä½ çš„ React åº”ç”¨ (`frontend`) æ„å»ºåçš„ `index.html` æ–‡ä»¶çš„ç¡®åˆ‡ä½ç½®ï¼Œå¹¶é…ç½® Django çš„ `settings.py` ( `TEMPLATES['DIRS']` æˆ– `STATICFILES_DIRS`) è®© Django èƒ½å¤Ÿæ‰¾åˆ°å®ƒã€‚
2.  **åˆ›å»ºå…¥å£è§†å›¾**: åœ¨ `workflows/views.py` ä¸­åˆ›å»º `workflow_spa_entry` è§†å›¾ï¼Œå¹¶ç”¨ `@custom_login_required` ä¿æŠ¤ï¼Œç¡®ä¿å®ƒèƒ½æ­£ç¡®æ¸²æŸ“ `index.html`ã€‚
3.  **é…ç½® URL**: åœ¨ `workflows/urls.py` ä¸­æ·»åŠ  `path('', ...)` å’Œ `re_path(r'^(?:.*)...', ...)` æŒ‡å‘å…¥å£è§†å›¾ï¼Œå¹¶ç»™åŸºç¡€è·¯å¾„ URL å‘½å (e.g., `workflow_spa_index`)ã€‚
4.  **åˆ†ç¦» API å’Œé¡µé¢è·¯ç”±**: åœ¨ä¸»é¡¹ç›® `urls.py` ä¸­ä½¿ç”¨ä¸åŒå‰ç¼€ `/api/workflows/` å’Œ `/workflows/` åˆ†åˆ«åŒ…å« API è·¯ç”±å’Œ SPA å…¥å£è·¯ç”±ã€‚
5.  **æ›´æ–°æ¨¡æ¿é“¾æ¥**: ä¿®æ”¹ `myapp` æ¨¡æ¿ä¸­çš„é“¾æ¥ï¼Œä½¿ç”¨ `{% url 'workflows-pages:workflow_spa_index' %}` æŒ‡å‘ SPA çš„å…¥å£ã€‚
6.  **é…ç½® React Router**: åœ¨ä½ çš„ React åº”ç”¨ (`frontend/src`) ä¸­ï¼Œç¡®ä¿ `react-router-dom` çš„ `BrowserRouter` é…ç½®äº† `basename="/workflows"`ï¼ˆå¦‚æœä½ çš„å…¥å£ URL æ˜¯ `/workflows/`ï¼‰ï¼Œè¿™æ ·å®ƒæ‰èƒ½æ­£ç¡®åŒ¹é… `/tasks`, `/designer/:id` ç­‰ç›¸å¯¹è·¯å¾„ã€‚

è¿™ä¸ªæµç¨‹ç¨å¾®å¤æ‚ä¸€äº›ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ° Django å’Œ React SPA çš„é›†æˆã€‚å…³é”®æ˜¯ç†è§£ Django ç°åœ¨ä¸»è¦è´Ÿè´£ API å’Œæä¾› SPA çš„åˆå§‹ HTMLï¼Œè€Œé¡µé¢å†…çš„å¯¼èˆªç”± React Router å¤„ç†ã€‚